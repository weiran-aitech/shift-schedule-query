<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Manager (Login & Signup)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #2c3e50; }
    form { margin-bottom: 20px; }
    input, button { padding: 6px; margin: 3px; }
    table { border-collapse: collapse; width: 80%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    .auth-section { display: flex; gap: 40px; }
    .auth-section form { border: 1px solid #ccc; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>Task Manager (with Login & Signup)</h1>

  <!-- Authentication Section -->
  <div class="auth-section">
    <!-- Login Form -->
    <form id="loginForm">
      <h3>Login</h3>
      <input type="text" id="login-username" placeholder="Username" required>
      <input type="password" id="login-password" placeholder="Password" required>
      <button type="submit">Login</button>
      <button type="button" onclick="logout()">Logout</button>
    </form>

    <!-- Signup Form -->
    <form id="signupForm">
      <h3>Signup</h3>
      <input type="text" id="signup-username" placeholder="Username" required>
      <input type="password" id="signup-password" placeholder="Password" required>
      <button type="submit">Signup</button>
    </form>
  </div>

  <p id="loginStatus">Not logged in</p>

  <!-- Add Task Form -->
  <form id="taskForm" style="display:none;">
    <input type="text" id="name" placeholder="Task Name" required>
    <input type="number" id="duration" placeholder="Duration (min)" required>
    <button type="submit">Add Task</button>
  </form>

  <!-- Task Table -->
  <table id="taskTable">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Duration</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const BASE_URL = "https://schedule-query.onrender.com/api"; // change to your Render backend
    const TASKS_URL = `${BASE_URL}/tasks`;
    const LOGIN_URL = `${BASE_URL}/login`;
    const SIGNUP_URL = `${BASE_URL}/signup`;

    let token = localStorage.getItem("token");

    function updateUI() {
      if (token) {
        document.getElementById("taskForm").style.display = "block";
        document.getElementById("loginStatus").innerText = "Logged in";
      } else {
        document.getElementById("taskForm").style.display = "none";
        document.getElementById("loginStatus").innerText = "Not logged in";
      }
    }

    async function login(username, password) {
      const params = new URLSearchParams();
      params.append("username", username);
      params.append("password", password);

      const res = await fetch(LOGIN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params
      });

      if (res.ok) {
        const data = await res.json();
        token = data.access_token;
        localStorage.setItem("token", token);
        updateUI();
        loadTasks();
      } else {
        alert("Login failed!");
      }
    }

    async function signup(username, password) {
      const params = new URLSearchParams();
      params.append("username", username);
      params.append("password", password);

      const res = await fetch(SIGNUP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params
      });

      if (res.ok) {
        alert("Signup successful! You can now log in.");
      } else {
        const err = await res.json();
        alert("Signup failed: " + (err.detail || "Unknown error"));
      }
    }

    function logout() {
      token = null;
      localStorage.removeItem("token");
      updateUI();
    }

    document.getElementById("loginForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const username = document.getElementById("login-username").value;
      const password = document.getElementById("login-password").value;
      login(username, password);
    });

    document.getElementById("signupForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const username = document.getElementById("signup-username").value;
      const password = document.getElementById("signup-password").value;
      signup(username, password);
    });

    async function loadTasks() {
      const res = await fetch(TASKS_URL);
      const data = await res.json();
      const tbody = document.querySelector("#taskTable tbody");
      tbody.innerHTML = "";
      data.tasks.forEach(task => {
        let actions = "";
        if (token) {
          actions = `
            <button onclick="editTask(${task.id})">Edit</button>
            <button onclick="deleteTask(${task.id})">Delete</button>`;
        }
        tbody.innerHTML += `<tr><td>${task.id}</td><td>${task.name}</td><td>${task.duration}</td><td>${actions}</td></tr>`;
      });
    }

    async function authFetch(url, options = {}) {
      if (!token) { alert("Login required"); return; }
      options.headers = {
        ...(options.headers || {}),
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      };
      return fetch(url, options);
    }

    document.getElementById("taskForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const duration = parseInt(document.getElementById("duration").value);

      await authFetch(TASKS_URL, {
        method: "POST",
        body: JSON.stringify({ name, duration })
      });
      e.target.reset();
      loadTasks();
    });

    updateUI();
    loadTasks();
  </script>
</body>
</html>
